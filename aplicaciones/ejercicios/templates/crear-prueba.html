{% extends 'aplicaciones/base.html' %}

{% block title %}Prueba - Mechonteca{% endblock title %}

{% block extra_css %}
<style>
    .card-rounded { border-radius: 12px; background: #fff; box-shadow: 0 6px 20px rgba(15,23,42,0.06); padding: 20px; border: 1px solid rgba(43,87,151,0.06); }
    .answer-option { padding: 8px 12px; border-radius: 8px; transition: all .12s ease; }
    .answer-option.selected { box-shadow: inset 0 0 0 2px rgba(34,197,94,0.12); background: #F7FFF7; }
    .answer-option.wrong { background: #FFF5F5; }
    .math-block { font-size: 1.05rem; color: #111827; }
</style>
{% endblock extra_css %}

{% block contenido %}

<div class="main-container">
    <div class="card-rounded page-content">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-semibold" style="font-family: 'Poppins', sans-serif;">Detalle de la Prueba</h1>
            <div class="text-sm text-gray-600">Prueba #{{ prueba.id }}</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="col-span-1">
                <p class="text-sm text-gray-600"><strong>Usuario:</strong> {{ prueba.usuario }}</p>
                <p class="text-sm text-gray-600"><strong>Creada:</strong> {{ prueba.fecha_creacion }}</p>
                <p class="text-sm text-gray-600"><strong>Completada:</strong> {{ prueba.fecha_completada }}</p>
            </div>
            <div class="col-span-2 text-right">
                <p class="text-sm text-gray-600"><strong>Cantidad preguntas:</strong> {{ prueba.cantidad_preguntas }}</p>
            </div>
        </div>

        <form method="post" action="{% url 'ejercicios:guardar-prueba' %}" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="prueba_id" value="{{ prueba.id }}" />

            {% for pregunta in preguntas %}
                <div class="border rounded-lg p-4" aria-labelledby="pregunta-{{ pregunta.id }}">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 id="pregunta-{{ pregunta.id }}" class="text-lg font-medium" style="font-family: 'Poppins', sans-serif;">Pregunta {{ pregunta.num_pregunta }} - {{ pregunta.topico }}</h3>
                                                        {% if pregunta.enunciado %}
                                                            <p class="text-sm text-gray-700 mt-1">{{ pregunta.enunciado|safe }}</p>
                                                        {% endif %}
                                                        {% if pregunta.ejercicio %}
                                                            <div class="math-block mt-2">${{ pregunta.ejercicio|safe }}$</div>
                                                        {% endif %}
                        </div>
                    </div>

                    <div class="mt-3 grid gap-2">
                        {% for alternativa in pregunta.alternativas %}
                            <label for="opt-{{ pregunta.id }}-{{ forloop.counter }}" class="flex items-center gap-3 p-2 border rounded-md hover:shadow-sm {% if pregunta.respuesta_correcta == alternativa.formula %}answer-option selected{% elif alternativa.seleccionada and pregunta.respuesta_correcta != alternativa.formula %}answer-option wrong{% else %}answer-option{% endif %}">
                                <input type="radio" name="pregunta_{{ pregunta.id }}" id="opt-{{ pregunta.id }}-{{ forloop.counter }}" value="{{ alternativa.formula }}" {% if modo_revision or prueba.completada %}disabled{% endif %} {% if alternativa.seleccionada %} checked {% endif %} {% if not modo_revision and not prueba.completada %}required{% endif %} class="h-4 w-4 text-sky-500" />
                                <div class="math-block">${{ alternativa.formula|safe }}$</div>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}

            <div class="flex justify-end">
                {% if not prueba.completada and not modo_revision %}
                    <button type="submit" class="btn-usm-primary px-6 py-2 rounded-md">
                        <i class="fa-solid fa-check mr-2"></i>Marcar alternativas
                    </button>
                {% else %}
                    {# In review/completed mode, hide the submit button but keep layout spacing #}
                    <div class="px-6 py-2"></div>
                {% endif %}
            </div>
        </form>

    </div>
</div>

{% endblock contenido %}

{% block extra_js %}
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] },
        options: { skipHtmlTags: ['script','noscript','style','textarea','pre'] }
    };
</script>
<script>
    // Interactividad: resaltar la opción seleccionada y mostrar spinner al enviar
    document.addEventListener('DOMContentLoaded', function () {
        // Resaltar al hacer click en la etiqueta
        document.querySelectorAll('label[for^="opt-"]').forEach(function(lbl){
            lbl.addEventListener('click', function(e){
                var container = lbl.closest('.mt-3');
                if (!container) container = lbl.closest('.border');
                // quitar selected de hermanos
                container.querySelectorAll('label[for^="opt-"]').forEach(function(s){
                    s.classList.remove('selected');
                });
                lbl.classList.add('selected');
            });
        });

        // Mostrar spinner en el botón al enviar
        var form = document.querySelector('form[method="post"]');
        if (form) {
            form.addEventListener('submit', function(e){
                var btn = form.querySelector('button[type="submit"]');
                if (btn) {
                    btn.disabled = true;
                    var spinner = document.createElement('span');
                    spinner.className = 'ml-2 inline-block animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full';
                    btn.appendChild(spinner);
                }
            });
        }
    });
</script>
{% endblock extra_js %}