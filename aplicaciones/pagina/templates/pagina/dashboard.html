{% extends 'pagina/base.html' %} 
{% block title %}Dashboard - USM{% endblock %}

{% block content %}
    <!-- Contenido de la SECCIÓN 2: DASHBOARD del boceto -->
    <section id="dashboard">
        {% if migration_error %}
        <div class="mb-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-800 rounded">
            <strong>Error:</strong> No se encontró la tabla de progreso. Por favor ejecuta las migraciones.
            <div class="mt-2 text-sm text-gray-700">
                Abre una terminal y ejecuta:
                <pre class="bg-gray-100 p-2 rounded mt-1">python manage.py makemigrations aplicaciones.pagina
python manage.py migrate</pre>
                Luego actualiza esta página.
            </div>
        </div>
        {% endif %}
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Tu Ruta de Nivelación</h1>

        <!-- MENSAJE DE BIENVENIDA DINÁMICO (Requiere JS) -->
        <div id="welcome-message" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow-md mb-6">
            <p class="font-semibold text-lg">Cargando mensaje de bienvenida...</p>
        </div>
        <!-- FIN MENSAJE DE BIENVENIDA DINÁMICO -->

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-2">Progreso General: {{ overall_percent }}%</h2>
            <div class="w-full md:w-full bg-gray-200 rounded-full h-4">
                <div class="progress-bar-bg h-4 rounded-full" style="width: {{ overall_percent }}%"></div>
            </div>
            <p class="text-sm text-gray-500 mt-2">{% if overall_percent < 100 %}¡Sigue así!{% else %}¡Has completado la ruta!{% endif %}</p>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for course in courses %}
            <div class="course-card bg-white p-6 rounded-xl shadow-md {% if course.percent >= 100 %}border-l-8 border-green-600{% elif course.percent > 0 %}border-l-8 border-blue-600{% else %}border-l-8 border-gray-400 opacity-70{% endif %}">
                <h3 class="text-2xl font-bold mb-3 {% if course.percent == 0 %}text-gray-500{% else %}text-gray-800{% endif %}">{{ course.name }}</h3>
                    <p class="text-sm {% if course.percent == 0 %}text-gray-400{% else %}text-gray-500{% endif %} mb-4">{% if course.name == 'Cálculo I' %}Análisis del tema, límites y derivadas esenciales.{% elif course.name == 'Álgebra' %}Vectores, matrices y sistemas de ecuaciones.{% elif course.name == 'Física' %}Mecánica clásica y termodinámica básica.{% endif %}</p>

                <div id="{{ course.name|slugify }}-topicos" class="space-y-2 text-sm hidden">
                    {% if course.topics %}
                        {% for tname, tpercent in course.topics.items %}
                        <div class="flex justify-between items-center py-1">
                            <span>{{ tname }}</span>
                            <span class="font-semibold {% if tpercent >= 100 %}text-green-600{% elif tpercent > 0 %}text-yellow-600{% else %}text-gray-400{% endif %}">{{ tpercent }}%</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-400">Aún no hay progreso.</p>
                    {% endif %}
                </div>
                <button class="toggle-topicos w-full mt-4 {% if course.percent > 0 %}bg-blue-100 text-blue-700{% else %}bg-gray-200 text-gray-700{% endif %} text-sm px-4 py-2 rounded-lg" data-target="{{ course.name|slugify }}-topicos">
                    Ver Tópicos
                </button>
                <button class="w-full inline-block mt-2 {% if course.percent > 0 %}btn-usm-primary text-sm{% else %}bg-blue-600 text-white text-sm{% endif %} px-4 py-2 rounded-lg text-center">
                    {% if course.percent > 0 %}Continuar{% else %}Comenzar{% endif %}
                </button>
            </div>
            {% endfor %}
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
    // JS para la lógica del Dashboard (mensajes de bienvenida y toggles)
    const welcomeMessages = [
        "¡Hola, Sansano! Tu ruta de nivelación te espera. ¡A darle con todo!",
        "El conocimiento es poder. Mira tu progreso y planifica tu próxima meta.",
        "Recuerda revisar el Almacén Colaborativo para nuevos apuntes y certámenes.",
        "¡Vamos por ese 100%! Tienes 3 cursos pendientes para alcanzar la meta.",
        "Tu esfuerzo de hoy es tu éxito de mañana. ¡Sigue avanzando!",
    ];

    function getWelcomeMessage() {
        const index = Math.floor(Math.random() * welcomeMessages.length);
        return welcomeMessages[index];
    }

    function updateWelcomeMessage() {
        const messageElement = document.getElementById('welcome-message');
        if (messageElement) {
            messageElement.querySelector('p').textContent = getWelcomeMessage();
        }
    }

    // Toggle para mostrar/ocultar tópicos en las tarjetas de curso
    document.querySelectorAll('.toggle-topicos').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const targetElement = document.getElementById(targetId);
            const isHidden = targetElement.classList.contains('hidden');
            
            // Cierra otros tópicos y restablece botones
            document.querySelectorAll('.toggle-topicos').forEach(btn => {
                const id = btn.getAttribute('data-target');
                document.getElementById(id).classList.add('hidden');
                btn.textContent = 'Ver Tópicos';
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-blue-100', 'text-blue-700');
            });

            // Abre el tópico clickeado
            if (isHidden) {
                targetElement.classList.remove('hidden');
                this.textContent = 'Ocultar Tópicos';
                this.classList.remove('bg-blue-100', 'text-blue-700');
                this.classList.add('bg-blue-600', 'text-white');
            }
        });
    });

    // Inicialización del mensaje de bienvenida
    window.onload = updateWelcomeMessage;
</script>
{% endblock %}
