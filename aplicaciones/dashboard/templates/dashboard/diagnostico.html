{% extends 'aplicaciones/base.html' %} 

{% block title %}{{ titulo_pagina }}{% endblock %}

{% block extra_css %}
<style>
  /* Page background + motion */
  .diagnostico-container {
    min-height: calc(100vh - 140px);
    background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
    display: flex;
    align-items: flex-start;
    padding: 40px 16px;
    animation: fadeIn 0.6s ease-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes slideUp {
    from { transform: translateY(10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  /* Card */
  .diagnostico-card {
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    border: 1px solid rgba(2,132,199,0.08);
    animation: slideUp 0.6s ease-out;
  }

  /* Title styling */
  .title-row { display: flex; align-items: center; gap: 12px; }
  .title-main { color: #1d4ed8; }
  .title-subject { color: #ef4444; }

  /* Back link */
  .back-link { color: #9ca3af; transition: color .2s ease; }
  .back-link:hover { color: #4b5563; }

  /* Inputs */
  .diagnostico-label { color: #334155; font-weight: 700; }
  .diagnostico-textarea {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    color: #0f172a;
    outline: none;
    transition: box-shadow .2s ease, border-color .2s ease;
    resize: vertical;
    background: #fff;
  }
  .diagnostico-textarea:focus {
    border-color: #60a5fa;
    box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
  }

  /* Details collapsibles */
  details.details-box {
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(2,132,199,0.18);
    background: #f0f9ff;
  }
  details.details-box summary {
    padding: 12px 14px;
    cursor: pointer;
    font-weight: 600;
    color: #1d4ed8;
    display: flex; align-items: center; justify-content: space-between;
    transition: background .2s ease;
    list-style: none;
  }
  details.details-box[open] summary { background: #e0f2fe; }
  details.details-box .details-content { padding: 14px 16px; background: #f8fafc; border-top: 1px solid #dbeafe; color: #334155; font-size: 0.95rem; }
  .details-arrow { transition: transform .2s ease; }
  details[open] .details-arrow { transform: rotate(180deg); }

  /* Secondary (yellow) box */
  details.details-box.secondary { border-color: rgba(234,179,8,0.34); background: #fef9c3; }
  details.details-box.secondary summary { color: #a16207; }
  details.details-box.secondary[open] summary { background: #fef08a; }
  details.details-box.secondary .details-content { background: #fffbeb; border-top-color: #fde68a; }

  /* Buttons */
  .btn-analizar {
    display: inline-block;
    width: 100%;
    padding: 12px 18px;
    border-radius: 12px;
    font-weight: 700;
    color: #fff;
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    border: none;
    cursor: pointer;
    transition: transform .15s ease, filter .2s ease, box-shadow .2s ease;
    box-shadow: 0 8px 18px rgba(37,99,235,0.25);
  }
  .btn-analizar:hover { transform: translateY(-2px); filter: brightness(0.97); box-shadow: 0 12px 24px rgba(37,99,235,0.28); }
  .btn-analizar:active { transform: translateY(0); }

  /* Result card styles */
  .result-title { color: #0f172a; }
  .result-level { color: #2563eb; }

  /* Loading text */
  .loading-text { color: #475569; font-weight: 600; animation: pulse 1.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity: .6} 50%{opacity:1} }
</style>
{% endblock extra_css %}

{% block contenido %}

<div class="diagnostico-container">
  <div class="relative max-w-4xl w-full mx-auto">
    <!-- Volver -->
    <a href="{% url 'dashboard:dashboard_view' %}" class="absolute -top-2 -left-1 back-link" title="Volver al Dashboard">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
    </a>

    <div class="mb-6">
      <h1 class="text-3xl md:text-4xl font-extrabold mb-2">
        <span class="title-main">Diagn칩stico de Desempe침o</span>:
        <span class="title-subject">{{ asignatura.nombre }}</span>
      </h1>
      <div class="h-[1px] bg-gradient-to-r from-blue-300 via-sky-200 to-transparent"></div>
    </div>
    
    {% if error_mensaje %}
      <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
          <p>{{ error_mensaje }}</p>
      </div>
    {% endif %}

    {% if resultado %}
        <!-- Resultados -->
        <div class="diagnostico-card p-8 text-center">
          <h2 class="text-2xl font-bold result-title mb-4">춰Diagn칩stico Completado!</h2>
          <p class="text-lg text-gray-600 mb-2">Basado en tu autoevaluaci칩n, tu nivel recomendado es:</p>
          <p class="text-4xl font-extrabold result-level mb-6">{{ resultado.nivel.nombre }}</p>

          <div class="text-left max-w-md mx-auto mb-8">
              <h3 class="font-bold text-lg text-gray-700 mb-3">Recomendaciones para ti:</h3>
              <ul class="list-disc list-inside space-y-2 text-gray-600">
                  {% for rec in resultado.recomendaciones %}
                      <li>{{ rec }}</li>
                  {% endfor %}
              </ul>
          </div>

          <a href="{% url 'dashboard:dashboard_view' %}" class="inline-block bg-gray-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-gray-700 transition duration-150">
              Volver al Dashboard
          </a>
        </div>

    {% else %}
        <!-- Formulario -->
        <form method="post" class="diagnostico-card p-8" onsubmit="mostrarCargando()">
            {% csrf_token %}

            <label for="autoevaluacion" class="block text-xl diagnostico-label mb-4">
                Describe tu desempe침o y progreso en {{ asignatura.nombre }}:
            </label>
            
            <p class="text-base text-gray-500 mb-6">Tu evaluaci칩n se analizar치 con Inteligencia Artificial para recomendarte un nivel de pr치ctica.</p>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <!-- Gu칤a -->
                <details class="details-box flex-1 cursor-pointer">
                    <summary class="font-semibold">
                        <span>游눠 Gu칤a para tu Respuesta</span>
                        <svg class="w-5 h-5 text-blue-700 details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="details-content">
                        <p class="mb-2">Para una mejor evaluaci칩n, describe tu desempe침o considerando:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li><strong>Nivel de comprensi칩n de conceptos:</strong> 쯈u칠 tan bien entiendes los fundamentos?</li>
                            <li><strong>Capacidad para resolver problemas:</strong> 쯇uedes aplicar los conceptos a ejercicios?</li>
                            <li><strong>Habilidad para explicar y aplicar conocimientos:</strong> 쯇uedes ense침ar lo que sabes?</li>
                            <li><strong>Independencia y creatividad en el aprendizaje:</strong> 쮺칩mo abordas nuevos desaf칤os?</li>
                        </ul>
                        <p class="mt-4 font-semibold">Especifica tambi칠n:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>Si estudias por tu cuenta y con qu칠 frecuencia.</li>
                            <li>Si buscas recursos adicionales (videos, libros, foros).</li>
                            <li>Si planificas tu estudio y resuelves ejercicios nuevos.</li>
                            <li>Si dependes de ayuda (profesor, IA, compa침eros) para resolver problemas.</li>
                        </ul>
                    </div>
                </details>

                <!-- Bot칩n desplegable de Niveles de Evaluaci칩n -->
                <details class="details-box secondary flex-1 cursor-pointer">
                    <summary class="font-semibold">
                        <span>游늵 Niveles de Evaluaci칩n</span>
                        <svg class="w-5 h-5 text-yellow-700 details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="details-content">
                        <p class="mb-2 font-semibold">Niveles (explicaci칩n):</p>
                        <ul class="list-disc list-inside space-y-2 pl-4">
                            <li><strong>B치sico:</strong> Tiene dificultades con conceptos fundamentales; requiere gu칤a frecuente.</li>
                            <li><strong>Intermedio:</strong> Resuelve ejercicios est치ndar correctamente y explica los pasos con cierta claridad.</li>
                            <li><strong>Avanzado:</strong> Demuestra dominio profundo; aplica conceptos a problemas nuevos, explica con detalle y propone soluciones originales.</li>
                        </ul>
                    </div>
                </details>
            </div>
            
            <textarea name="autoevaluacion" id="autoevaluacion" rows="10" required placeholder="Ejemplo: 'Tengo dominio de l칤mites por sustituci칩n directa, pero a칰n confundo la regla de la cadena con el producto para derivadas...'" class="diagnostico-textarea mb-6"></textarea>
    
            <div id="botones-accion" class="mt-8">
                <button type="submit" class="btn-analizar" id="submit-btn">
                    Analizar mi Respuesta
                </button>
            </div>

            <!-- Cargando -->
            <div id="cargando" class="hidden mt-6 text-center">
                <p class="loading-text">Analizando tu respuesta con IA, por favor espera...</p>
            </div>
        </form>
    {% endif %}

  </div>
</div>

<script>
    function mostrarCargando() {
        const botones = document.getElementById('submit-btn');
        if (botones) {
            botones.style.display = 'none';
        }
        document.getElementById('cargando').classList.remove('hidden');
    }
</script>

{% endblock contenido %}